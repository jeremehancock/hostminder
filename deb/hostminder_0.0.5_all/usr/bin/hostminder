#!/bin/bash
# Copyright (c) 2021 Jereme Hancock <support@ubuntuce.com>

# MIT License

# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:

# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.

# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.

APP_TITLE="Host Minder"

check_status() {
  HOSTS=$(head /etc/hosts | grep "GENERATED BY $APP_TITLE" | awk '{print $0}')
  STEVEN=$(head /etc/hosts | grep "Title: StevenBlack/hosts" | awk '{print $0}')
  if [[ $HOSTS == "# GENERATED BY $APP_TITLE"* ]] || [[ $STEVEN == "# Title: StevenBlack/hosts"* ]]
    then
      echo "ON"
  else
    echo "OFF"
  fi
}

get_toggle() {
  STATUS=$(check_status)
  if [[ $STATUS == *"ON"* ]]
    then
      echo "OFF"
  else
    echo "ON"
  fi
}

get_status_color() {
  STATUS=$(check_status)
  if [[ $STATUS == *"ON"* ]]
    then
      echo "#228B22"
  else
    echo "#CC0000"
  fi
}

get_level() {
  LEVEL=$(head /etc/hosts | grep "GENERATED BY $APP_TITLE" | awk '{print $6}')
  if [[ $LEVEL ]]
    then
      echo "\n\nCurrent Protection Level: <b>$LEVEL</b>"
  fi
}

get_total_domains() {
DOMAINS=$(head /etc/hosts | grep "# Number of unique domains" | awk '{print $6}')
if [[ $DOMAINS ]]
  then
	  echo "\n\nTotal Unique Domains: <b>$DOMAINS</b>"
fi
}

check_safe_searchstatus() {
  STATUS=$(grep "# Google Safe Search - Host Minder" /etc/hosts | awk '{print $0}')
  if [[ $STATUS ]]
    then
      echo "ENABLED"
  else
    echo "DISABLED"
  fi
}

get_safe_searchstatus_color() {
  STATUS=$(check_safe_searchstatus)
  if [[ $STATUS == *"ENABLED"* ]]
    then
      echo "#228B22"
  else
    echo "#CC0000"
  fi
}

settings() {
  STATUS=$(check_status)
  STATUS_COLOR=$(get_status_color)
  TOGGLE=$(get_toggle)
  LEVEL=$(get_level)
  DOMAINS=$(get_total_domains)
  SAFESEARCH_STATUS=$(check_safe_searchstatus)
  SAFESEARCH_STATUS_COLOR=$(get_safe_searchstatus_color)
  if [[ $STATUS == "ON" ]]
    then
      UPDATE="Change/Update Protection Level"
      ALLOW="Edit Allow List"
      HELP="What's Host Minder?"
  else
    UPDATE="What's Host Minder?"
    ALLOW=""
    HELP=""
  fi
  SWITCH=$(zenity --window-icon=/usr/share/pixmaps/hostminder.png --list --title="$APP_TITLE: Settings" --width=400 --height=350 --text="Status: <span color='$STATUS_COLOR'><b>$STATUS</b></span>$LEVEL$DOMAINS\n\nGoogle Safe Search: <span color='$SAFESEARCH_STATUS_COLOR'><b>$SAFESEARCH_STATUS</b></span>\n" --column= --hide-header "Turn $TOGGLE" "$UPDATE" "$ALLOW" "$HELP")
  case $SWITCH in

  "Turn ON")
    select_level fresh
    ;;

  "Turn OFF")
    revert_hosts
    ;;

  "Change/Update Protection Level")
    select_level
    ;;

  "Edit Allow List")
    cp /opt/hostminder/allow /tmp/hostminder.allow
    zenity --window-icon=/usr/share/pixmaps/hostminder.png --info --title "$APP_TITLE" --width=500 --text $"\n<big>The Allow List only affects domains blocked by Host Minder.\n\nKeep in mind that DNS Minder may still be blocking the domain.</big>"
    gedit -w /tmp/hostminder.allow
    sed -i '/^[[:space:]]*$/d' /tmp/hostminder.allow
    confirm_save_allow_list
    settings
    ;;

  "What's Host Minder?")
    xdg-open "https://github.com/mhancoc7/hostminder#readme"
    settings
    ;;

  *)
    exit 1
    ;;
  esac
}

select_level() {
  if [[ $1 == "fresh" ]]
    then
      zenity --window-icon=/usr/share/pixmaps/hostminder.png --info --title "$APP_TITLE" --width=450 --text $"\n<big>This tool will download and setup a new /etc/hosts file.\n\nIt will be making changes to your system and should be USED AT YOUR OWN RISK!\n\nIt is recommended that you have system backups.</big>"
  fi
  STATUS=$(check_status)
  STATUS_COLOR=$(get_status_color)
  LEVEL=$(get_level)
  DOMAINS=$(get_total_domains)
  SAFESEARCH_STATUS=$(check_safe_searchstatus)
  SAFESEARCH_STATUS_COLOR=$(get_safe_searchstatus_color)
  SELECT=$(zenity --window-icon=/usr/share/pixmaps/hostminder.png --list --title="$APP_TITLE: Settings" --width=400 --height=350 --text="Status: <span color='$STATUS_COLOR'><b>$STATUS</b></span>$LEVEL$DOMAINS\n\nGoogle Safe Search: <span color='$SAFESEARCH_STATUS_COLOR'><b>$SAFESEARCH_STATUS</b></span>\n\nSelect Protection Level" --column=Name --column=Description Max "Ads / Porn / Gambling / Social / Fake News" High "Ads / Porn / Gambling / Social" Medium "Ads / Porn / Gambling" Low "Ads / Porn")
  case $SELECT in

  "Max")
    update_hosts max
    ;;

  "High")
    update_hosts high
    ;;

  "Medium")
    update_hosts medium
    ;;

  "Low")
    update_hosts low
    ;;

  *)
    settings
    ;;
  esac
}

confirm() {
  if
    zenity --window-icon=/usr/share/pixmaps/hostminder.png --question --title "$APP_TITLE" --no-wrap --text="\nAre you sure?"
  then
    return
  else
    settings
  fi
}

confirm_save_allow_list() {
  if
    zenity --window-icon=/usr/share/pixmaps/hostminder.png --question --title "$APP_TITLE" --no-wrap --text="\nSave &amp; Apply Allow List?"
  then
      if [[ "$LEVEL" == "\n\nCurrent Protection Level: <b>(Max):</b>" ]]
        then
          update_hosts max auto allow
      elif [[ "$LEVEL" == "\n\nCurrent Protection Level: <b>(High):</b>" ]]
        then
            update_hosts high auto allow
      elif [[ "$LEVEL" == "\n\nCurrent Protection Level: <b>(Medium):</b>" ]]
        then
            update_hosts medium auto allow
      elif [[ "$LEVEL" == "\n\nCurrent Protection Level: <b>(Low):</b>" ]]
        then
          update_hosts low auto allow
      else
        return
      fi
  else
    settings
  fi
}

general_failure() {
  zenity --window-icon=/usr/share/pixmaps/hostminder.png --error --title "$APP_TITLE" --no-wrap --text="\nSomething went wrong!"
}

wget_failure() {
  zenity --window-icon=/usr/share/pixmaps/hostminder.png --error --title "$APP_TITLE" --no-wrap --text="\nCould not download hosts file.\n\nPlease check your internet connection!"
}

FALLBACK="127.0.0.1 localhost
127.0.0.1 localhost.localdomain
127.0.0.1 local
255.255.255.255 broadcasthost
::1 localhost
::1 ip6-localhost
::1 ip6-loopback
fe80::1%lo0 localhost
ff00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
ff02::3 ip6-allhosts
0.0.0.0 0.0.0.0
"

update_hosts() {
  if [ "$2" != "auto" ]
    then
      confirm
  fi

  if [[ "$1" == "max" ]]
    then
      LIST="https://raw.githubusercontent.com/StevenBlack/hosts/master/alternates/fakenews-gambling-porn-social/hosts"
    elif [[ "$1" == "high" ]]
      then
        LIST="https://raw.githubusercontent.com/StevenBlack/hosts/master/alternates/gambling-porn-social/hosts"
    elif [[ "$1" == "medium" ]]
      then
        LIST="https://raw.githubusercontent.com/StevenBlack/hosts/master/alternates/gambling-porn/hosts"
    elif [[ "$1" == "low" ]]
      then
        LIST="https://raw.githubusercontent.com/StevenBlack/hosts/master/alternates/porn/hosts"
    else
      LIST="https://raw.githubusercontent.com/StevenBlack/hosts/master/alternates/porn/hosts"
  fi
  (
    echo "# \nGetting new hosts file (${1^})\n"
    sleep 2
    if wget -q "$LIST" -O /tmp/bad.host.list.hostminder.txt
      then
        echo "# \nApplying Allow List\n"
        sleep 2

        if [ -f /tmp/hostminder.allow ]
          then
            while read line; do
              if [[ ${line} != *"#"* ]]
                then
                  sed -i "/$line/d" /tmp/bad.host.list.hostminder.txt
              fi
            done </tmp/hostminder.allow
        else
          if [[ ${line} != *"#"* ]]
            then
              sed -i "/$line/d" /tmp/bad.host.list.hostminder.txt
          fi
        fi

        pkexec bash -c "
        if grep -q 'GENERATED BY $APP_TITLE' /etc/hosts
          then
            echo '# \nExtracting custom entries\n'
            sleep 2
            sed -n '/# \nCustom host records are listed here./I,/# End of custom host records./I{ /# /Id; p }' /etc/hosts > /etc/hosts_hostminder_bak
          else
            echo '# \nBacking up current hosts file\n'
            sleep 2
            cp /etc/hosts /etc/hosts_hostminder_bak
        fi

        sed -i '/^[[:space:]]*$/d' /etc/hosts_hostminder_bak

        echo '# \nSetting up new hosts file\n'
        sleep 2
        if [ -f /tmp/bad.host.list.hostminder.txt ]
          then
          sleep 2
          sed -i '1i# GENERATED BY $APP_TITLE (${1^}): PLEASE DO NOT EDIT OR REMOVE THIS LINE' /tmp/bad.host.list.hostminder.txt
          cp /tmp/bad.host.list.hostminder.txt /etc/hosts

          if [ $3 ]
            then
              mv /tmp/hostminder.allow /opt/hostminder/allow
          fi

          echo '# \nAdding current hosts entries to new hosts file\n'
          sleep 2
          sed -i -e '/# Custom host records are listed here./r /etc/hosts_hostminder_bak' /etc/hosts

          echo '# \nEnabling Google Safe Search\n'
          sleep 2
          echo '# Google Safe Search - Host Minder' >> /etc/hosts
          echo '216.239.38.120     www.google.com       #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com       #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.ad        #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.ae        #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.af    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.ag    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.ai    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.al        #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.am        #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.co.ao     #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.ar    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.as        #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.at        #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.au    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.az        #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.ba        #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.bd    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.be        #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.bf        #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.bg        #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.bh    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.bi        #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.bj        #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.bn    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.bo    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.br    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.bs        #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.bt        #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.co.bw     #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.by        #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.bz    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.ca        #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.cd        #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.cf        #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.cg        #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.ch        #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.ci        #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.co.ck     #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.cl        #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.cm        #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.cn        #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.co    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.co.cr     #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.cu    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.cv        #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.cy    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.cz        #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.de    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.dj    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.dk    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.dm    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.do    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.dz    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.ec    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.ee    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.eg    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.es    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.et    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.fi    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.fj    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.fm    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.fr    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.ga    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.ge    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.gg    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.gh    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.gi    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.gl    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.gm    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.gr    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.gt    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.gy    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.hk    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.hn    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.hr    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.ht    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.hu    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.co.id    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.ie    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.co.il    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.im    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.co.in    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.iq    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.is    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.it    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.je    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.jm    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.jo    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.co.jp    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.co.ke    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.kh    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.ki    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.kg    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.co.kr    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.kw    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.kz    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.la    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.lb    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.li    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.lk    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.co.ls    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.lt    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.lu    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.lv    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.ly    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.co.ma    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.md    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.me    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.mg    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.mk    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.ml    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.mm    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.mn    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.ms    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.mt    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.mu    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.mv    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.mw    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.mx    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.my    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.co.mz    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.na    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.ng    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.ni    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.ne    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.nl    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.no    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.np    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.nr    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.nu    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.co.nz    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.om    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.pa    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.pe    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.pg    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.ph    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.pk    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.pl    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.pn    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.pr    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.ps    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.pt    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.py    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.qa    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.ro    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.ru    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.rw    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.sa    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.sb    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.sc    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.se    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.sg    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.sh    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.si    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.sk    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.sl    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.sn    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.so    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.sm    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.sr    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.st    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.sv    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.td    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.tg    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.co.th    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.tj    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.tl    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.tm    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.tn    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.to    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.tr    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.tt    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.tw    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.co.tz    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.ua    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.co.ug    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.co.uk    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.uy    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.co.uz    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.vc    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.co.ve    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.vg    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.co.vi    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.com.vn    #forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.vu    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.ws    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.rs    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.co.za    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.co.zm    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.co.zw    	#forcesafesearch' >> /etc/hosts
          echo '216.239.38.120     www.google.cat    	#forcesafesearch' >> /etc/hosts

          if ! grep -q '[^[:space:]]' /etc/hosts
            then
              echo '# \nSomething went wrong! Reverting to fallback hosts file.\n'
              sleep 2
              echo '$FALLBACK' | tee /etc/hosts
            else
              echo '# \nAdding auto update crontab\n'
              sleep 2
              crontab -l | grep -v 'hostminder' | crontab -
              (crontab -l && echo '0 0 * * 0 hostminder ${1}') | crontab -
          fi

          echo '# \nCleaning up\n'
          sleep 2
          rm /etc/hosts_hostminder_bak
          rm /tmp/bad.host.list.hostminder.txt
          fi
        "
      echo "# \nAll finished\n"
      sleep 2
    else
      if [ "$2" != "auto" ]
        then
          wget_failure
      fi
    fi

  ) |
    zenity --progress \
      --title="$APP_TITLE: Progress" \
      --width=400 \
      --height=100 \
      --percentage=0 \
      --auto-close \
      --auto-kill \
      --no-cancel \
      --pulsate \
      --window-icon=/usr/share/pixmaps/hostminder.png

    (($? != 0)) && general_failure

  if [ "$2" != "auto" ]
    then
      settings
  fi
}

revert_hosts() {
  if [ "$1" != "auto" ]
    then
      confirm
  fi

(
	echo "# \nReverting to original hosts file\n"
	sleep 2
	pkexec bash -c "
		if grep -q 'GENERATED BY $APP_TITLE' /etc/hosts
		  then
		  echo '# \nExtracting custom entries\n'
		  sleep 2
		  sed -n '/# Custom host records are listed here./I,/# End of custom host records./I{ /# /Id; p }' /etc/hosts > /etc/hosts_hostminder_bak
		else
		  echo '# \nBacking up current hosts file\n'
		  sleep 2
		  cp /etc/hosts /etc/hosts_hostminder_bak
		fi

		sed -i '/^[[:space:]]*$/d' /etc/hosts_hostminder_bak
		cp /etc/hosts_hostminder_bak /etc/hosts

		if ! grep -q '[^[:space:]]' /etc/hosts
		  then
      echo '# \nSomething went wrong! Reverting to fallback hosts file\n'
		  sleep 2
		  echo '$FALLBACK' | tee /etc/hosts
		fi

    echo '# \nRemoving auto update crontab\n'
    sleep 2
    crontab -l | grep -v 'hostminder' | crontab -

		echo '# \nCleaning up\n'
		sleep 2
		rm /etc/hosts_hostminder_bak
		rm /tmp/bad.host.list.hostminder.txt
	"

	echo "# \nAll finished\n"
	sleep 2

) |
	zenity --progress \
		--title="$APP_TITLE: Progress" \
		--width=400 \
		--height=100 \
		--percentage=0 \
		--auto-close \
		--auto-kill \
		--no-cancel \
		--pulsate \
		--window-icon=/usr/share/pixmaps/hostminder.png

(($? != 0)) && zenity --window-icon=/usr/share/pixmaps/hostminder.png --error --text="Error in zenity command."

if [ "$1" != "auto" ]
  then
    settings
fi
}

if [ "$1" == "low" ] || [ "$1" == "medium" ] || [ "$1" == "high" ] || [ "$1" == "max" ]
  then
    update_hosts "$1" auto
elif [ "$1" == "off" ]
  then
    revert_hosts auto
else
  settings fresh
fi

